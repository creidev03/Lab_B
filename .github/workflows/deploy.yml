name: Sync from Lab_A to Lab_B

on:
  schedule:
    - cron: '50 5 * * 5'
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout destination (Lab_B)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Trae todo el historial para evitar conflictos de merge

      - name: Clone Lab_A (public repo)
        run: |
          mkdir -p "$RUNNER_TEMP/lab_a"
          # Forzamos el clon de la rama main del Repo A
          git clone -b main --single-branch https://github.com/creidev03/Lab_A.git "$RUNNER_TEMP/lab_a"

      - name: Sync files with Rsync
        run: |
          # El flag -i (itemize-changes) nos dirá exactamente qué archivos cambiaron en los logs
          rsync -avi --delete "$RUNNER_TEMP/lab_a/" . \
            --exclude .git \
            --exclude '.github/workflows/**' \
            --exclude '.github/workflows'

      - name: Check for changes (Debug)
        run: |
          echo "=== Archivos modificados detectados por Git ==="
          git status --porcelain
          if [ -z "$(git status --porcelain)" ]; then
            echo "No se detectaron cambios reales entre los repositorios."
          fi

      - name: Get changelog diff
        id: changelog
        run: |
         # 1. Definimos el nombre correcto del archivo
          FILENAME="changelog.md"
          
          # 2. Intentamos obtener la versión previa desde el main del Repo B
          if git show origin/main:$FILENAME > /tmp/old_changelog 2>/dev/null; then
            echo "Comparando contra versión previa de $FILENAME"
          else
            echo "" > /tmp/old_changelog
            echo "No se encontró versión previa de $FILENAME en origin/main"
          fi
          
          # 3. Verificamos si el archivo existe en el clon del Repo A
          NEW_FILE="$RUNNER_TEMP/lab_a/$FILENAME"
          
          if [ -f "$NEW_FILE" ]; then
            # Si el archivo viejo estaba vacío, tomamos las primeras 20 líneas del nuevo
            if [ ! -s /tmp/old_changelog ]; then
              head -n 20 "$NEW_FILE" > /tmp/new_changelog_lines.txt
            else
              # Sacamos solo las líneas que empiezan por + (los cambios nuevos)
              git --no-pager diff --no-index --unified=0 /tmp/old_changelog "$NEW_FILE" \
              | awk '/^\+[^+]/ {print substr($0,2)}' > /tmp/new_changelog_lines.txt || true
            fi
          else
            echo "El archivo $FILENAME no existe en Lab_A" > /tmp/new_changelog_lines.txt
          fi
          
          # 4. Enviamos al output de GitHub de forma segura
          echo "body<<EOF" >> $GITHUB_OUTPUT
          if [ -s /tmp/new_changelog_lines.txt ]; then
            cat /tmp/new_changelog_lines.txt >> $GITHUB_OUTPUT
          else
            echo "Sin cambios detectados en el contenido del archivo." >> $GITHUB_OUTPUT
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "sync: update from Lab_A main"
          title: "Sync from Lab_A — Nuevos cambios detectados"
          body: |
            Se han encontrado cambios en `Lab_A`.
            
            **Detalles del changelog:**
            ${{ steps.changelog.outputs.body }}
          branch: sync/update-from-lab-a
          # Importante: delete-branch borra la rama temporal después del merge para que no estorbe
          delete-branch: true 
          base: main