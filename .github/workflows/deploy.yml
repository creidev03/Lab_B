name: Sync from Lab_A to Lab_B

on:
  schedule:
    - cron: '50 5 * * 5' # Friday 05:50 UTC -> 00:50 America/Bogota
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    # Definimos la salida para que el nodo 'notification' sepa qué PR se creó
    outputs:
      pr_number: ${{ steps.cpr.outputs.pull-request-number }}
    steps:
      - name: Checkout destination (Lab_B)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Lab_A (public repo)
        run: |
          mkdir -p "$RUNNER_TEMP/lab_a"
          git clone -b main --single-branch https://github.com/creidev03/Lab_A.git "$RUNNER_TEMP/lab_a"

      - name: Sync files with Rsync
        run: |
          rsync -avi --delete "$RUNNER_TEMP/lab_a/" . \
            --exclude .git \
            --exclude '.github/workflows/**' \
            --exclude '.github/workflows'

      - name: Get changelog diff
        id: changelog
        run: |
          FILENAME="changelog.md"
          if git show origin/main:$FILENAME > /tmp/old_changelog 2>/dev/null; then
            git --no-pager diff --no-index --unified=0 /tmp/old_changelog "$RUNNER_TEMP/lab_a/$FILENAME" \
            | awk '/^\+[^+]/ {print substr($0,2)}' > /tmp/new_changelog_lines.txt || true
          else
            cat "$RUNNER_TEMP/lab_a/$FILENAME" > /tmp/new_changelog_lines.txt 2>/dev/null || echo "Sin cambios" > /tmp/new_changelog_lines.txt
          fi
          
          echo "body<<EOF" >> $GITHUB_OUTPUT
          head -c 3000 /tmp/new_changelog_lines.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "sync: update from Lab_A main"
          title: "Sync from Lab_A — Nuevos cambios detectados"
          body: |
            Se han encontrado cambios en `Lab_A`.
            
            **Detalles del changelog:**
            ${{ steps.changelog.outputs.body }}
          branch: sync/update-from-lab-a
          delete-branch: true 
          base: main

  notification:
    needs: sync
    # Este nodo solo corre si realmente se creó una Pull Request
    if: needs.sync.outputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        id: date
        run: echo "today=$(date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

      - name: Send notification email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: carlosreina2100@gmail.com
          # Recuerda configurar este Secret en GitHub (EMAIL_PASSWORD)
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[AUTOMATIZADO] Nueva PR de sincronización - ${{ steps.date.outputs.today }}"
          to: creidev03@gmail.com
          from: GitHub Automation <carlosreina2100@gmail.com>
          body: |
            Hola,
            
            Se ha generado una nueva Pull Request automatizada para sincronizar Lab_A con Lab_B.
            
            Detalles:
            - Fecha: ${{ steps.date.outputs.today }}
            - Estado: Automatizado mediante GitHub Actions.
            - Número de PR: #${{ needs.sync.outputs.pr_number }}
            - Enlace: ${{ github.server_url }}/${{ github.repository }}/pull/${{ needs.sync.outputs.pr_number }}
            
            Por favor, revisa los cambios y realiza el merge si todo es correcto.