name: Sync from Lab_A to Lab_B

# Se ejecuta programado (UTC): Friday 05:50 -> 00:50 America/Bogota
on:
  schedule:
    - cron: '50 5 * * 5'
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: sync-lab-a-to-lab-b
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout destination (Lab_B)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone Lab_A (public repo) into runner temp
        run: |
          mkdir -p "$RUNNER_TEMP/lab_a"
          git clone https://github.com/creidev03/Lab_A.git "$RUNNER_TEMP/lab_a"

      - name: Copy files from Lab_A
        run: |
          # Sincroniza los archivos al directorio actual de trabajo
          rsync -av --delete --stats "$RUNNER_TEMP/lab_a/" . \
            --exclude .git \
            --exclude '.github/workflows/**' \
            --exclude '.github/workflows' || true

      - name: Get changelog new lines for PR body
        id: changelog
        run: |
          if git show origin/main:changelog > /tmp/old_changelog 2>/dev/null; then
            true
          else
            echo "" > /tmp/old_changelog
          fi
          
          if [ -s "$RUNNER_TEMP/lab_a/changelog" ] ; then
            if [ -s /tmp/old_changelog ]; then
              git --no-pager diff --no-index --unified=0 /tmp/old_changelog "$RUNNER_TEMP/lab_a/changelog" \
                | awk '/^\+[^+]/ {print substr($0,2)}' > /tmp/new_changelog_lines.txt || true
            else
              cat "$RUNNER_TEMP/lab_a/changelog" > /tmp/new_changelog_lines.txt
            fi
          else
            echo "" > /tmp/new_changelog_lines.txt
          fi
          
          # Corrección: Sintaxis multilínea requerida para GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          head -c 3000 /tmp/new_changelog_lines.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "sync: update from Lab_A main"
          title: "Sync from creidev03/Lab_A — automatic"
          body: |
            Nuevos cambios detectados en `changelog` (extraído desde `Lab_A`):

            ${{ steps.changelog.outputs.body }}
          # La action maneja la creación de la rama automáticamente
          branch: sync/from-lab-a
          branch-suffix: timestamp 
          base: main